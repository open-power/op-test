#!/usr/bin/perl
# IBM_PROLOG_BEGIN_TAG
# This is an automatically generated prolog.
#
# $Source: op-auto-test/bvt/run-bvt-setup $
#
# OpenPOWER Automated Test Project
#
# Contributors Listed Below - COPYRIGHT 2015
# [+] International Business Machines Corp.
#
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing
# permissions and limitations under the License.
#
# IBM_PROLOG_END_TAG
################################################################################
# Setup an OP CI BVT test config file per the passed arguments
#
# Author: Alan Hlava
################################################################################
use strict;

use Getopt::Long;

my $verbose = 0;
my $vp_indent = "";
my $bmcip = "";
my $bmcuser = "";
my $bmcpwd = "";
my $usernameipmi = "";
my $passwordipmi = "";
my $imagedir = "";
my $ffdcdir = "ffdc/";
my $imagename = "habanero.pnor";
my $cfgfiledir = ".";
my $lparip = "";
my $lparuser = "";
my $lparPasswd = "";
my $hpmimage = "";

my $usage = "Setup an OP CI BVT test config file per the passed arguments

Syntax: run-bvt-setup --bmcip x.x.x.x --bmcpwd xxx --usernameipmi xxx --passwordipmi xxx [OPTIONS]

Where OPTIONS is zero or more of:
   --bmcuser [xxx] : BMC user name
   --bmcpwd [xxx] : BMC password
   --usernameipmi [xxx] : IPMI user name
   --passwordipmi [xxx] : IPMI password
   --ffdcdir [xxx] : Directory for FFDC data (default=$ffdcdir)
   --imagedir [xxx] : Directory containing flash image
   --imagename [xxx] : Flash image file name (default=$imagename)
   --cfgfiledir [xxx] : Directory to store the generated config file (default=$cfgfiledir)
   --verbose : Display extra debug statements during execution
\n";

my $cfgfile = "op_ci_tools.cfg";
my $cfgfile_fmt = "[bmc]
ip = %s
username = %s
password = %s
usernameipmi = %s
passwordipmi = %s
prompt = \#

[test]
ffdcdir = %s
imagedir = %s
imagename = %s

[lpar]
lparip = %s
lparuser = %s
lparPasswd = %s
prompt = \#
hpmimage = %s

";

sub syntax()
{
        print "$usage";
        exit(1);
}

sub vprint
{
    print @_ if $verbose;
}

$| = 1; # Force STDOUT to be unbuffered (flush after every print statement)

# Parse the arguments
my $help = 0;
GetOptions("help|?|h" => \$help,
	   "verbose" => \$verbose,
	   "bmcip=s" => \$bmcip,
	   "bmcuser:s" => \$bmcuser,
	   "bmcpwd=s" => \$bmcpwd,
	   "usernameipmi=s" => \$usernameipmi,
	   "passwordipmi=s" => \$passwordipmi,
	   "lparip=s" => \$lparip,
	   "lparuser=s" => \$lparuser,
	   "lparPasswd=s" => \$lparPasswd,
	   "hpmimage:s" => \$hpmimage,
	   "ffdcdir:s" => \$ffdcdir,
	   "cfgfiledir:s" => \$cfgfiledir,
	   "imagedir:s" => \$imagedir,
	   "imagename:s" => \$imagename,
    ) or syntax();

syntax() if $help;

vprint "Starting run-bvt-setup\n";

# The OP CI tools want dirs to end in slash...
if ($ffdcdir !~ /\/$/) { $ffdcdir .= "/"; }
if ($imagedir !~ /\/$/) { $imagedir .= "/"; }

# Write the config file
open(OUTF, ">${cfgfiledir}/${cfgfile}") || die "ERROR: unable to open ${cfgfiledir}/${cfgfile} for output: $!";
printf OUTF $cfgfile_fmt,
        $bmcip,
        $bmcuser,
        $bmcpwd,
        $usernameipmi,
        $passwordipmi,
        $ffdcdir,
        $imagedir,
        $imagename,
        $lparip,
        $lparuser,
        $lparPasswd,
        $hpmimage;
close(OUTF);
if ($verbose)
{
        my $tmp = `cat ${cfgfiledir}/${cfgfile}`;
        vprint "Config file ${cfgfiledir}/${cfgfile} written:\n";
        vprint $tmp;
}
